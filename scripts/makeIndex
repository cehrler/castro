#!/usr/bin/perl

use strict;

my $neListFile = $ARGV[0];
my $inpFilesList = $ARGV[1];

open(NELIST, "<$neListFile") || die "Can't open $neListFile";
open(INPFILES, "<$inpFilesList") || die "Can't open $inpFilesList";

my %neTypeCounts = ();
my %NE = ();
my $neTyp = "";
my $ind = 1;
my %index = ();

while (my $line = <NELIST>)
{
	chomp($line);
	if ($line =~ m/^<(.*)>$/)
	{
	   if ($neTyp ne "")
	   {
	   	 $neTypeCounts{$neTyp} = $ind - 1;
	   	 
	   }
	   $neTyp = $1;
	   $NE{$neTyp} = {};
	   print "neTyp = $neTyp\n";
	   $ind = 1;
	}
	else
	{
		#print "line: $line\n";
		if ($line =~ m/^([0-9]+) (.*)$/)
		{
		  $NE{$neTyp}{$2} = $1;
		  
		  if ($1 != $ind) { die "$1 is not equal to $ind!"; }
		  
		  #print "NE{$neTyp}{$1} = ".$NE{$neTyp}{$1}."\n";
		  $ind++;
		}
		else
		{
			#die "Line doesn't match: $line";
		}
	}

}

close(NELIST);

my $neName;
my $neCount;

my $counter = 0;

while (my $line = <INPFILES>)
{
	chomp($line);
	my $mod = "";
	
	if ($line =~ m/^([0-9]+) (.*)/)
	{
		if ($1 != $counter + 1) { die "$1 != $counter + 1"; }
		$line = "../data/".$2.".nerd";
	}
	
	open(FILE, "<$line") || die "Can't open file $line";
	#print "$line\n";
	while (my $radek = <FILE>)
	{
		chomp($radek);
	    #print "processing: $radek\n";
		if ($radek =~ m/^<(.*)>$/)
		{
			if ($1 ne "PERSONS" && $1 ne "LOCATIONS" && $1 ne "ORGANIZATIONS")
			{
				next;
			}
			if (defined($NE{$1}))
			{
				$mod = $1;
			}
			else
			{
				print "Undefined NE: $1\n";				
				$mod = "";
			}
		}
		elsif ($mod ne "")
		{
			if ($radek =~ m/^(.*) ([0-9]+)$/)
			{
			  $neName = $1;
			  $neCount = $2;
			  if (!(defined($NE{$mod}{$neName})))
			  {
			  	die "Undefined named entity: $mod->$neName";
			  }
			  
			 
			  $index{$mod}[$counter][$NE{$mod}{$neName} - 1] = $neCount;
			  #print "{$mod}[$counter][".$NE{$mod}{$neName}." - 1] = ".$index{$mod}[$counter][$NE{$mod}{$neName} - 1]."\n";
			}
			else
			{
				die "NE line doesn't match: $radek";
			}
			
		}
		
	}
	
	$counter++;
	close(FILE);
}

close(INPFILES);

foreach my $key (keys %index)
{
  open(INDEXOUT, ">$key.ind");

  print "creating index: $key.ind\n";
  my @indF = @{$index{$key}};
  print INDEXOUT "speeches:".scalar(@indF)."\n";
  print INDEXOUT "NEs:".$neTypeCounts{$key}."\n";
  
  for (my $i = 0; $i < scalar(@indF); $i++)
  {
  	if ($indF[$i] == undef)
  	{
  		#print STDERR "undef line\n";
  		for (my $j = 0; $j < $neTypeCounts{$key}; $j++)
  		{
  			print INDEXOUT "0\n"; 
  		}
  		print INDEXOUT "-----\n";
  		next;
  	}
  	my @indOF = @{$indF[$i]};
  	for (my $j = 0; $j < $neTypeCounts{$key}; $j++)
  	{
  	  my $val = $indOF[$j];
  	  if ($val eq "") { print INDEXOUT "0\n"; }
  	  else
  	  {
  	  	if (! $val =~ m/^[0-9]+$/ ) { die "strange value: $val"; }
  	    print INDEXOUT "$val\n"; 
  	  }
  	}
  	print INDEXOUT "-----\n";
  }

  close(INDEXOUT);
  
}

